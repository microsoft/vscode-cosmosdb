name: Node PR Lint, Build and Test

on:
    # Trigger when manually run
    workflow_dispatch:

    # Trigger on pushes to `main` or `rel/*`
    push:
        branches:
            - main
            - rel/*

    # Trigger on pull requests to `main` or `rel/*`
    pull_request:
        branches:
            - main
            - rel/*
            - dev/*

jobs:
    Build:
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: '.'

        steps:
            # Setup
            - uses: actions/checkout@v4
            - name: Using Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: .nvmrc

            - name: ‚öñÔ∏è Validate Version / Preview Alignment
              shell: pwsh
              run: |
                  $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
                  $version = $packageJson.version
                  $preview = [bool]$packageJson.preview

                  Write-Output "üì¶ Package version: $version"
                  Write-Output "üè∑Ô∏è Preview flag: $preview"

                  # Validate semantic versioning format
                  if ($version -notmatch '^(\d+)\.(\d+)\.(\d+)$') {
                      Write-Error "‚ùå Invalid semantic version format: $version"
                      exit 1
                  }

                  $minor = [int]$Matches[2]
                  $minorEven = ($minor % 2) -eq 0

                  # Check version/preview alignment
                  # Convention: odd minor versions = preview, even minor versions = stable
                  if ($preview -and $minorEven) {
                      Write-Warning "‚ö†Ô∏è Version/preview misalignment: preview=$preview but minor version $minor is even (should be odd for preview)"
                      Write-Warning "Convention: Odd minor versions (e.g., 1.1.x, 1.3.x) should be preview, even (e.g., 1.0.x, 1.2.x) should be stable"
                  } elseif (-not $preview -and -not $minorEven) {
                      Write-Warning "‚ö†Ô∏è Version/preview misalignment: preview=$preview but minor version $minor is odd (should be even for stable)"
                      Write-Warning "Convention: Odd minor versions (e.g., 1.1.x, 1.3.x) should be preview, even (e.g., 1.0.x, 1.2.x) should be stable"
                  } else {
                      Write-Output "‚úÖ Version/preview alignment is correct"
                  }

            - run: npm ci

            - name: Localize
              run: npm run l10n:check

            - name: Lint
              run: npm run lint

            - name: Prettier
              run: npm run prettier

            - name: Compile
              run: npm run build

            - name: Package
              run: npm run package

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: Artifacts
                  path: |
                      **/*.vsix
                      **/*.tgz
                      !**/node_modules

            - name: Unit Tests
              run: npm run jesttest

            - name: Integration Tests
              run: xvfb-run -a npm test
